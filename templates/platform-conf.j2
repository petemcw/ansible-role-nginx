{% extends "vhost-conf.j2" %}
{% block platform %}
{% for key,value in item.server.iteritems() %}
{% if key == 'platform' %}
{% for platform in value %}
{% if platform.subdir is defined and platform.subdir|lower != 'none' %}
{% set location_dir = platform.subdir %}
{% else %}
{% set location_dir = '' %}
{% endif %}
{% if platform.name|lower == 'cmsms' %}

    ###
    #
    # START CMSMS CONFIGURATION
    #
    ###

    # Attempted to match last if rules below fail.
    # http://wiki.nginx.org/HttpCoreModule
    location /{{ location_dir }} {
        try_files $uri $uri/ /{{ location_dir }}index.php?page=$request_uri;
        expires max;
    }

    ###
    #
    # END CMSMS CONFIGURATION
    #
    ###

{% endif %}
{% if platform.name|lower == 'drupal' %}

    ###
    #
    # START DRUPAL CONFIGURATION
    #
    ###

    # Deny access to files the public doesn't need
    location ~* ^.+(\.(txt|log|engine|inc|info|install|make|module|profile|test|po|sh|sql|theme|tpl(\.php)?|xtmpl))$ {
        internal;
    }

    # Deny access to other PHP files
    location ~ \..*/.*\.php {
        internal;
    }

    # Deny access to private and backups
    location ~* ^/{{ location_dir }}sites/.*/(private|files/backup_migrate)/ {
        access_log off;
        return 404;
    }

    # Attempt to serve the request by trying direct file, directory, Drupal Controller
    location /{{ location_dir }} {
        try_files $uri $uri/ /{{ location_dir }}index.php?q=$uri&$args;
        expires max;
    }

    # Check: http://wiki.nginx.org/Pitfalls
    location ~* (install|update|apc|info)\.php$ {
        auth_basic "Restricted";
        auth_basic_user_file {{ nginx_config_dir }}/.htpasswd;

        # do not cache dynamic content
        expires off;

        # php5 specific configuration options
        include {{ nginx_config_dir }}/fastcgi_params;
    }

    # Below locations are for image cache
    location ~* files/styles {
        access_log off;
        log_not_found off;
        expires max;
        try_files $uri @image_rewrite;
    }

    # Drupal 5/6 image cache
    location ~* files/imagecache {
        access_log off;
        log_not_found off;
        expires max;
        try_files $uri @image_rewrite;
    }

    location @image_rewrite {
        rewrite ^/(.*)$ /{{ location_dir }}index.php?q=$1;
    }

    ###
    #
    # END DRUPAL CONFIGURATION
    #
    ###

{% endif %}
{% if platform.name|lower == 'magento' %}

    ###
    #
    # START MAGENTO CONFIGURATION
    #
    ###

    # Denied locations require a "^~" to prevent regexes (such as the PHP handler below) from matching
    # http://nginx.org/en/docs/http/ngx_http_core_module.html#location
    location ^~ /{{ location_dir }}app/                 { return 403; }
    location ^~ /{{ location_dir }}config/              { return 403; }
    location ^~ /{{ location_dir }}includes/            { return 403; }
    location ^~ /{{ location_dir }}media/customer/      { return 403; }
    location ^~ /{{ location_dir }}media/downloadable/  { return 403; }
    location ^~ /{{ location_dir }}pkginfo/             { return 403; }
    location ^~ /{{ location_dir }}report/config.xml    { return 403; }
    location ^~ /{{ location_dir }}var/                 { return 403; }
    location ^~ /{{ location_dir }}lib/                 { return 403; }
    location ^~ /{{ location_dir }}dev/                 { return 403; }
    location ^~ /{{ location_dir }}shell/               { return 403; }
    location ^~ /{{ location_dir }}RELEASE_NOTES.txt    { return 403; }
    location ^~ /{{ location_dir }}downloader/pearlib   { return 403; }
    location ^~ /{{ location_dir }}downloader/template  { return 403; }
    location ^~ /{{ location_dir }}downloader/Maged     { return 403; }
    location ~* ^/{{ location_dir }}errors/.+\.xml      { return 403; }
    location ^~ /{{ location_dir }}cron.php             { return 403; }

    # CVE-2015-3428 / AW_Blog vulnerability
    # Note the .+ at the start: We want to allow url's like
    # order=create_date, which would otherwise match.
    if ($arg_order ~* .+(select|create|insert|update|drop|delete|concat|alter|load)) {
        return 403;
    }

    # Restrict access to admins
    location /{{ location_dir }}var/export {
        auth_basic "Restricted";
        auth_basic_user_file {{ nginx_config_dir }}/.htpasswd;
        autoindex on;
    }

    # Attempt to serve the request by trying direct file, directory, Magento controller
    location /{{ location_dir }} {
        try_files $uri $uri/ @handler;
        expires max;
    }

    # SUPEE 6285
    # Only allow the new url case sensitive lowercase, deny case insensitive
    location ^~ /rss/order/new {
        echo_exec @handler;
    }
    location ^~ /rss/catalog/notifystock {
        echo_exec @handler;
    }
    location ^~ /rss/catalog/review {
        echo_exec @handler;
    }
    location ~* /rss/order/new {
        return 403;
    }
    location ~* /rss/catalog/notifystock {
        return 403;
    }
    location ~* /rss/catalog/review {
        return 403;
    }

    ## Order IS important! this is required BEFORE the PHP regex
    ## Allow PHP scripts in skin and JS, but render static 404 pages when skin or js file is missing
    ## Magento has RewriteCond %{REQUEST_URI} !^/(media|skin|js)/ in default htaccess
    location ~ ^/(skin|js)/ {
        location ~ \.php$ {
            echo_exec @phpfpm;
        }
        try_files $uri $uri/ =404;
        expires 30d;
    }
    # Disallow PHP scripts in /media/
    # Also render static 404 pages for missing media
    location ~ ^/media/ {
        location ~ \.php$ {
            return 403;
        }
        try_files $uri $uri/ =404;
        expires 30d;
    }

    location @handler {
        rewrite / /{{ location_dir }}index.php?$args;
    }

    # The downloader has its own index.php that needs to be used
    location ~* ^(/{{ location_dir }}downloader)(.*) {
        try_files $uri $uri/ /{{ location_dir }}downloader/index.php$1;
    }

    # REST API endpoint
    location /{{ location_dir }}api {
        rewrite ^/{{ location_dir }}api/rest /{{ location_dir }}api.php?type=rest last;
        rewrite ^/{{ location_dir }}api/v2_soap /{{ location_dir }}api.php?type=v2_soap last;
        rewrite ^/{{ location_dir }}api/soap /{{ location_dir }}api.php?type=soap last;
    }

    ###
    #
    # END MAGENTO CONFIGURATION
    #
    ###

{% endif %}
{% if platform.name|lower == 'wordpress' %}

    ###
    #
    # START WORDPRESS CONFIGURATION
    #
    ###

    # Deny access to any files with a .php extension in the uploads directory
    # Works in sub-directory installs and also in multisite network
    # Keep logging the requests to parse later (or to pass to firewall utilities such as fail2ban)
    location ~* /{{ location_dir }}(?:uploads|files)/.*\.php$ {
        deny all;
    }

    # Attempted to match last if rules below fail.
    # http://wiki.nginx.org/HttpCoreModule
    location /{{ location_dir }} {
        try_files $uri $uri/ /{{ location_dir }}index.php?$args;
        expires max;
    }

    # Add trailing slash to */wp-admin requests.
    rewrite /{{ location_dir }}wp-admin$ $scheme://$host$uri/ permanent;

    ###
    #
    # END WORDPRESS CONFIGURATION
    #
    ###

{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endblock %}
