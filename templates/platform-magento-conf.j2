{% extends "vhost-conf.j2" %}
{% block platform %}
{% if item.server.platform_subdir is defined and item.server.platform_subdir|lower != 'none' %}
{% set location_dir = item.server.platform_subdir %}
{% else %}
{% set location_dir = '' %}
{% endif %}

    ###
    #
    # START MAGENTO CONFIGURATION
    #
    ###

    # Deny access to files the public doesn't need
    location ^~ /(app|config|includes|lib|media/customer|media/downloadable|pkginfo|report/config.xml|shell|var)/ {
        internal;
    }

    # Restrict access to admins
    location /{{ location_dir }}var/export {
        auth_basic "Restricted";
        auth_basic_user_file {{ nginx_config_dir }}/.htpasswd;
        autoindex on;
    }

    # Attempt to serve the request by trying direct file, directory, Magento controller
    location /{{ location_dir }} {
        try_files $uri $uri/ /{{ location_dir }}index.php?$args;
        expires max;
    }

    # The downloader has its own index.php that needs to be used
    location ~* ^(/downloader)(.*) {
        try_files $uri $uri/ /{{ location_dir }}downloader/index.php$1;
    }

    # REST API endpoint
    location /{{ location_dir }}api {
        rewrite ^/{{ location_dir }}api/rest /{{ location_dir }}api.php?type=rest last;
    }

    ###
    #
    # END MAGENTO CONFIGURATION
    #
    ###

{% endblock %}
